"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.runElevated = runElevated;
exports.downloadToFile = downloadToFile;
const lodash_1 = __importDefault(require("lodash"));
const support_1 = require("appium/support");
const node_util_1 = require("node:util");
const node_child_process_1 = require("node:child_process");
const bluebird_1 = __importDefault(require("bluebird"));
const logger_1 = require("./logger");
const execAsync = (0, node_util_1.promisify)(node_child_process_1.exec);
/**
 * This API triggers UAC when necessary
 *
 * @param {string} cmd
 * @param {string[]} args
 * @param {import('node:child_process').ExecOptions & {timeoutMs?: number}} opts
 * @returns {Promise<{stdout: string; stderr: string;}>}
 * @throws {import('node:child_process').ExecException}
 *
 * Notes:
 * - If the UAC prompt is cancelled by the user, Start-Process returns a non-zero exit code.
 */
async function runElevated(cmd, args = [], opts = {}) {
    const { timeoutMs = 60 * 1000 * 5 } = opts;
    const escapePSSingleQuoted = (/** @type {string} */ str) => `'${String(str).replace(/'/g, "''")}'`;
    const psFilePath = escapePSSingleQuoted(cmd);
    const psArgList = lodash_1.default.isEmpty(args) ? "''" : args.map(escapePSSingleQuoted).join(',');
    // Build the PowerShell Start-Process command (safe quoting for inner tokens)
    const psCommand = `Start-Process -FilePath ${psFilePath} -ArgumentList ${psArgList} -Verb RunAs`;
    // Wrap the PowerShell command in double-quotes for the outer shell call.
    // We avoid additional interpolation here by using only single-quoted literals inside the PS command.
    const fullCmd = `powershell -NoProfile -Command "${psCommand}"`;
    logger_1.log.debug(`Executing command: ${fullCmd}`);
    const { stdout, stderr } = /** @type {any} */ (await bluebird_1.default.resolve(execAsync(fullCmd, opts))
        .timeout(timeoutMs, `The command '${fullCmd}' timed out after ${timeoutMs}ms`));
    return {
        stdout: lodash_1.default.isString(stdout) ? stdout : stdout.toString(),
        stderr: lodash_1.default.isString(stderr) ? stderr : stderr.toString(),
    };
}
/**
 *
 * @param {string} srcUrl
 * @param {string} dstPath
 * @returns {Promise<void>}
 */
async function downloadToFile(srcUrl, dstPath) {
    await support_1.net.downloadFile(srcUrl, dstPath);
}
//# sourceMappingURL=utils.js.map